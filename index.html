<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Кэшбэк-акции банков</title>
<style>
  :root{--accent:#222;--bg:#fff;--muted:#888;}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
       margin:0;padding:1rem;background:var(--bg);color:var(--accent);}
  h1{font-size:1.5rem;margin:0 0 1rem}
  .filters{display:flex;flex-wrap:wrap;gap:.5rem;margin-bottom:1rem}
  .filters select,
  .filters input{padding:.4rem .6rem;border:1px solid var(--muted);border-radius:4px;font:inherit;min-width:140px}
  .filters select[multiple]{min-width:180px}   /* чуть шире под многострочный список */
  .filters button{padding:.4rem .9rem;border:none;border-radius:4px;background:var(--accent);color:#fff;cursor:pointer}
  .filters button:hover{opacity:.9}
  table{width:100%;border-collapse:collapse;margin-bottom:1rem}
  thead{position:sticky;top:0;background:#f6f6f6}
  th,td{padding:.55rem .6rem;border-bottom:1px solid #e4e4e4;text-align:left}
  tr{cursor:pointer;transition:background .15s}
  tr:hover{background:#fafafa}
  #details{display:none;padding:1rem;border:1px solid #e4e4e4;border-radius:6px;white-space:pre-line}
  @media(max-width:600px){.filters select{flex:1 1 48%}}
</style>
</head>
<body>

<h1>Кэшбэк-акции банков</h1>

<div class="filters">
  <!-- multiple: можно выбрать несколько банков -->
  <select id="bankFilter" multiple size="4" title="Банк"><option value="" hidden>Банк</option></select>
  <select id="categoryFilter"><option value="">Категория</option></select>
  <select id="brandFilter"><option value="">Компания/бренд</option></select>
  <select id="cashbackFilter"><option value="">Размер кэшбека/скидки</option></select>
  <input type="search" id="searchInput" placeholder="Поиск…" />
  <button id="resetBtn">Сбросить</button>
</div>

<div style="overflow-x:auto;">
  <table id="dataTable" style="display:none;">
    <thead><tr>
      <th>Банк</th>
      <th>Компания/бренд</th>
      <th>Размер кэшбека/скидки</th>
    </tr></thead>
    <tbody></tbody>
  </table>
</div>

<pre id="details"></pre>

<script>
// ---------- ДАННЫЕ (замените/дополните) ----------
const data = [
  {
    "Банк":"Т-Банк","Карта":"Black","Категория":"Еда и продукты",
    "Компания/бренд":"Tasty Coffee","Размер кэшбека/скидки ":"Кэшбэк 3%",
    "Условия":"На 1 покупку онлайн от 5 ₽",
    "Короткое описание":"Интернет-магазин свежего кофе",
    "Даты проведения акции":"С 12 по 26 мая",
    "Как получить кэшбэк":"…","Макс. кэшбек/скидка в руб":300,
    "Сайт":"https://shop.tastycoffee.ru/?utm_source=tinkoff",
    "О партнере":"Tasty Coffee — интернет-магазин обжарщика кофе."
  },
  {
    "Банк":"Т-Банк","Карта":"Black","Категория":"Еда и продукты",
    "Компания/бренд":"Мануфактура Кофе","Размер кэшбека/скидки ":"Кэшбэк 40%",
    "Условия":"На покупки онлайн","Короткое описание":"Зерновой кофе",
    "Даты проведения акции":"С 5 мая по 4 июля","Как получить кэшбэк":"…",
    "Макс. кэшбек/скидка в руб":"2000 бонусов",
    "Сайт":"https://manufactorycoffee.ru/",
    "О партнере":"Мануфактура кофе — обжарщик из Санкт-Петербурга."
  },
  {
    "Банк":"Т-Банк","Карта":"Black","Категория":"Еда и продукты",
    "Компания/бренд":"Elementaree","Размер кэшбека/скидки ":"Скидка 40%",
    "Условия":"На 1 покупку онлайн от 3 000 ₽",
    "Короткое описание":"Наборы продуктов с рецептами",
    "Промокод":"tbanknew","Даты проведения акции":"С 1 по 31 мая",
    "Как получить кэшбэк":"…","Доп. информация":"…",
    "Макс. кэшбек/скидка в руб":"Не указан","Сайт":"https://elementaree.ru/",
    "О партнере":"Elementaree — доставка готовых наборов."
  }
];
// ---------- /ДАННЫЕ ----------

// --- нормализуем название поля с лишним пробелом ---
data.forEach(o=>{
  if(o["Размер кэшбека/скидки "] && !o["Размер кэшбека/скидки"]){
    o["Размер кэшбека/скидки"] = o["Размер кэшбека/скидки "];
    delete o["Размер кэшбека/скидки "];
  }
});

// --- DOM-ссылки ---
const els = {
  bank:      document.getElementById('bankFilter'),
  category:  document.getElementById('categoryFilter'),
  brand:     document.getElementById('brandFilter'),
  cashback:  document.getElementById('cashbackFilter'),
  search:    document.getElementById('searchInput'),
  reset:     document.getElementById('resetBtn'),
  table:     document.getElementById('dataTable'),
  tbody:     document.getElementById('dataTable').querySelector('tbody'),
  details:   document.getElementById('details')
};

// --- сопоставление id фильтра ↔ поле JSON ---
const filterMap = {
  bank:     "Банк",
  category: "Категория",
  brand:    "Компания/бренд",
  cashback: "Размер кэшбека/скидки"
};

// --- исходные варианты значений для каждого фильтра ---
const masterOptions = {};
Object.entries(filterMap).forEach(([id,key])=>{
  masterOptions[id] = [...new Set(data.map(d=>d[key]))].sort();
  fillSelect(els[id], masterOptions[id]);
});

function fillSelect(select, values){
  const placeholder = select.options[0];      // первый option — заглушка
  select.length = 1;                          // сохраняем только плейсхолдер
  values.forEach(v=>{
    const opt = document.createElement('option');
    opt.value = v; opt.textContent = v;
    select.appendChild(opt);
  });
}

// --- helpers ---
const getMultiVals = sel => [...sel.selectedOptions].map(o=>o.value).filter(Boolean);

// --- подписки на изменения ---
Object.keys(filterMap).forEach(id=>{
  els[id].addEventListener('change', ()=>updateFilters(id));
});
els.search.addEventListener('input', updateTable);
els.reset.addEventListener('click', resetAll);

// --- текущий набор выбранных фильтров ---
function currentSel(){
  const s={};
  for(const id in filterMap){
    const key = filterMap[id];
    if(id==='bank'){                  // мультивыбор
      const vals = getMultiVals(els.bank);
      if(vals.length) s[key]=vals;    // массив банков
    }else{
      const val = els[id].value;
      if(val) s[key]=val;
    }
  }
  return s;
}

// --- динамика фильтров ---
function updateFilters(changedId){
  const sel = currentSel();

  for(const id in filterMap){
    if(id===changedId) continue;      // «активный» фильтр не сужаем
    const key = filterMap[id];
    // возможные значения для id при учёте остальных фильтров
    const vals = data.filter(row=>{
      for(const k in sel){
        if(k===key) continue;         // поле, которое сейчас собираем
        const flt = sel[k];
        if(Array.isArray(flt)){ if(!flt.includes(row[k])) return false; }
        else if(row[k]!==flt) return false;
      }
      return true;
    }).map(r=>r[key]);

    const uniq = [...new Set(vals)].sort();

    if(id==='bank'){                  // мультиселект
      const selected = getMultiVals(els.bank);
      fillSelect(els.bank, uniq);
      // восстановим выборы, которые ещё актуальны
      [...els.bank.options].forEach(o=>{
        if(selected.includes(o.value)) o.selected = true;
      });
    }else{
      fillSelect(els[id], uniq);
      if(!uniq.includes(els[id].value)) els[id].value='';
    }
  }
  updateTable();
}

// --- отрисовка таблицы ---
function updateTable(){
  const sel = currentSel();
  const q   = els.search.value.trim().toLowerCase();

  const rows = data.filter(row=>{
    // селекты
    for(const k in sel){
      const flt = sel[k];
      if(Array.isArray(flt)){ if(!flt.includes(row[k])) return false; }
      else if(row[k]!==flt) return false;
    }
    // поиск
    if(q){
      return Object.values(row).some(v=>String(v).toLowerCase().includes(q));
    }
    return true;
  });

  renderRows(rows);

  const visible = Object.keys(sel).length>0 || q;
  els.table.style.display = visible ? '' : 'none';
}

function renderRows(rows){
  els.tbody.innerHTML='';
  rows.forEach(row=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${row["Банк"]}</td>
      <td>${row["Компания/бренд"]}</td>
      <td>${row["Размер кэшбека/скидки"]}</td>`;
    tr.addEventListener('click', ()=>showDetails(row));
    els.tbody.appendChild(tr);
  });
}

function showDetails(row){
  els.details.style.display = 'block';     // исправлено: явно «block»
  els.details.textContent = Object.entries(row)
    .map(([k,v])=>`${k}: ${v}`).join('\n');
  els.details.scrollIntoView({behavior:'smooth'});
}

function resetAll(){
  // сброс мультиселекта банков
  [...els.bank.options].forEach(o=>o.selected=false);
  // сброс остальных
  Object.keys(filterMap).forEach(id=>{
    if(id!=='bank') els[id].value='';
    fillSelect(els[id], masterOptions[id]);
  });
  els.search.value='';
  els.details.style.display='none';
  updateTable();
}

// --- инициализация ---
updateTable();
</script>
</body>
</html>
